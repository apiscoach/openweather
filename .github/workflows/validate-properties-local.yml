name: Validate API Definition and MetaData

on:
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path to the ZIP file containing API properties'
        required: true
        type: string

permissions:
  contents: read
  checks: write

jobs:
  validate-api-definition:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout wso2-rulesets repository
        uses: actions/checkout@v4
        with:
          repository: '${{ github.repository_owner }}/wso2-rulesets'
          path: 'wso2-rulesets'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract API definition files from ZIP
        id: extract-api
        run: |
          echo "Extracting API definition files from ZIP"
          echo "========================================"

          # Use the provided ZIP file path
          ZIP_FILE="${{ inputs.zip_path }}"

          if [[ ! -f "$ZIP_FILE" ]]; then
            echo "Error: ZIP file not found at: $ZIP_FILE"
            exit 1
          fi

          echo "Found ZIP file: $ZIP_FILE"

          # Extract ZIP file to workspace
          unzip -q "$ZIP_FILE" -d ./extracted-api

          # Find api.yaml
          API_YAML=$(find ./extracted-api -name "api.yaml" -type f)
          if [[ -z "$API_YAML" ]]; then
            echo "Error: api.yaml not found in ZIP file"
            exit 1
          fi

          echo "Found api.yaml: $API_YAML"
          echo "api_yaml_path=$API_YAML" >> $GITHUB_OUTPUT

          # Find swagger.yaml in Definitions folder
          SWAGGER_YAML=$(find ./extracted-api -path "*/Definitions/swagger.yaml" -type f)
          if [[ -n "$SWAGGER_YAML" ]]; then
            echo "Found swagger.yaml: $SWAGGER_YAML"
            echo "swagger_yaml_path=$SWAGGER_YAML" >> $GITHUB_OUTPUT
          else
            echo "Warning: swagger.yaml not found in Definitions folder"
            echo "swagger_yaml_path=" >> $GITHUB_OUTPUT
          fi

          # List extracted structure
          echo "Extracted file structure:"
          find ./extracted-api -type f | head -20

      # - name: Run YAML lint with vacuum
      #   uses: pb33f/vacuum-action@v2
      #   with:
      #     openapi_path: '${{ steps.extract-api.outputs.api_yaml_path }}'
      #     ruleset: 'wso2-rulesets/rules/propertiesValidation.yml'
      #     show_rules: true
      #     fail_on_error: true
      #     minimum_score: 20
      #     print_logs: true
      #     github_token: ${{ secrets.GITHUB_TOKEN }}   

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli

      - name: Validate OpenAPI Compliance with Spectral CLI
        run: |
          spectral lint '${{ steps.extract-api.outputs.swagger_yaml_path }}' \
              --ruleset 'wso2-rulesets/rules/basicValidation.yaml' \
              --format github-actions

      - name: Validate API custom properties with Spectral CLI
        run: |
          spectral lint '${{ steps.extract-api.outputs.api_yaml_path }}' \
            --ruleset 'wso2-rulesets/rules/propertiesValidation.yml' \
            --format github-actions
